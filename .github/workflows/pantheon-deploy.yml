name: Pantheon Deploy

on:
  push:
    branches:
      - main  # Replace with your branch if needed
  workflow_dispatch:  # Allows you to manually trigger this workflow for testing

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Terminus (Pantheon CLI)
        run: |
          curl -O https://github.com/pantheon-systems/terminus/releases/latest/download/terminus.phar
          chmod +x terminus.phar
          sudo mv terminus.phar /usr/local/bin/terminus

      - name: Log in to Pantheon
        env:
          PANTHEON_MACHINE_TOKEN: ${{ secrets.PANTHEON_MACHINE_TOKEN }}
        run: |
          terminus auth:login --machine-token="$PANTHEON_MACHINE_TOKEN"

      # Connection Test Step
      - name: Fetch Pantheon Site Info (Connection Test)
        env:
          PANTHEON_SITE_UUID: ${{ secrets.PANTHEON_SITE_UUID }}
        run: |
          terminus site:info $PANTHEON_SITE_UUID

      - name: Deploy to Pantheon
        env:
          PANTHEON_SITE_UUID: ${{ secrets.PANTHEON_SITE_UUID }}
        run: |
          terminus connection:set $PANTHEON_SITE_UUID.dev git
          git push ssh://codeserver.dev.$PANTHEON_SITE_UUID@codeserver.dev.$PANTHEON_SITE_UUID.drush.in:2222/~/repository.git main


